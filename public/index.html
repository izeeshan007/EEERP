<!DOCTYPE html>
<html>
<head>
<title>Perfume ERP PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>

<style>
.card{
 background:white;
 border-radius:16px;
 padding:16px;
 box-shadow:0 2px 10px rgba(0,0,0,.08);
}
.input{
 width:100%;
 padding:10px;
 border:1px solid #ddd;
 border-radius:10px;
}
.modal{
 position:fixed;
 inset:0;
 background:rgba(0,0,0,.5);
 display:none;
 justify-content:center;
 align-items:center;
}
.modal-box{
 background:white;
 padding:20px;
 border-radius:12px;
 width:95%;
 max-width:450px;
}
tr:hover{background:#f9fafb;cursor:pointer}
</style>
</head>

<body class="bg-gray-100 p-4">

<h1 class="text-3xl font-bold mb-5">Perfume ERP PRO</h1>

<!-- DASHBOARD -->

<div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">

<div class="card">Investment <p id="investment"></p></div>
<div class="card">Sales <p id="sales"></p></div>
<div class="card">Profit <p id="profit"></p></div>
<div class="card">ROI <p id="roi"></p></div>

</div>

<!-- STOCK ENTRY -->

<div class="card mb-6">

<h2 class="text-xl font-bold mb-3">Stock Entry</h2>

<select id="category" onchange="changeFields()" class="input mb-2">
<option>Attar Oil</option>
<option>Raw Perfume</option>
<option>Bottle</option>
<option>Pouch</option>
<option>Box</option>
<option>Aroma Chemical</option>
<option>Equipment</option>
<option>Misc</option>
</select>

<div id="dynamicFields" class="grid gap-2"></div>

<button onclick="addStock()" class="bg-blue-600 text-white px-4 py-2 rounded mt-3">
Add Stock
</button>

<p id="stockMsg" class="text-green-600 mt-2"></p>

</div>

<!-- ================= SALES ENTRY ================= -->

<div class="card mb-6">

<h2 class="text-xl font-bold mb-3">Sales Entry (Auto Cost)</h2>

<div class="grid md:grid-cols-3 gap-2">

<!-- PRODUCT TYPE -->
<select id="saleCat" class="input" onchange="changeSaleMode()">
<option value="Perfume">Perfume</option>
<option value="Attar">Attar</option>
</select>

<!-- PRODUCT NAME (FROM ATTAR OIL STOCK) -->
<input id="productName"
list="oilList"
class="input"
placeholder="Attar Oil Name"
oninput="calculateMfgCost()">

<datalist id="oilList"></datalist>

<!-- SIZE -->
<select id="saleSize" class="input"
onchange="calculateMfgCost()"></select>

<!-- OIL % (ONLY PERFUME) -->
<input id="oilPercent"
class="input"
type="number"
value="45"
placeholder="Oil %"
oninput="calculateMfgCost()">

<!-- BOTTLE CATEGORY -->
<select id="bottleCat"
class="input"
onchange="calculateMfgCost()">

<option value="">Bottle Category</option>
<option>ECO</option>
<option>Premium</option>

</select>

<!-- BOX CATEGORY -->
<select id="boxCat"
class="input"
onchange="calculateMfgCost()">

<option value="">Box Category (Optional)</option>
<option>ECO</option>
<option>Premium</option>

</select>

<!-- OTHER COST -->
<input id="otherCost"
type="number"
class="input"
placeholder="Other Cost"
oninput="calculateMfgCost()">

<!-- AUTO MFG COST -->
<input id="mfg"
class="input bg-gray-100 font-bold"

placeholder="Auto Manufacturing Cost">

<!-- SOLD -->
<input id="sold"
class="input"
type="number"
placeholder="Sold Price">

<input id="customer" class="input" placeholder="Customer">
<input id="reference" class="input" placeholder="Reference">

<input id="date" type="date" class="input">

</div>

<button onclick="addSale()"
class="bg-green-600 text-white px-4 py-2 rounded mt-3">
Add Sale
</button>

</div>

<!-- STOCK TABLE -->

<div class="card mb-6">

<h2 class="text-xl font-bold mb-2">Stock Records</h2>
<input id="stockFilter" class="input mb-2" placeholder="Search" oninput="loadAll()">

<table class="w-full">
<thead><tr class="bg-gray-100"><th>Name</th><th>Category</th><th>Units</th><th>Cost</th></tr></thead>
<tbody id="stockTable"></tbody>
</table>

</div>

<!-- SALES TABLE -->

<div class="card">

<h2 class="text-xl font-bold mb-2">Sales Records</h2>
<input id="salesFilter" class="input mb-2" placeholder="Search" oninput="loadAll()">

<table class="w-full">
<thead><tr class="bg-gray-100"><th>Product</th><th>Customer</th><th>Profit</th></tr></thead>
<tbody id="salesTable"></tbody>
</table>

</div>

<!-- ================= ANALYTICS ================= -->

<div class="card mt-6">

<h2 class="text-xl font-bold mb-3">
Monthly Analytics
</h2>

<div class="overflow-auto mb-4">
<table class="w-full text-sm">
<thead class="bg-gray-100">
<tr>
<th>Month</th>
<th>Investment</th>
<th>Sales</th>
<th>Profit</th>
<th>ROI</th>
</tr>
</thead>

<tbody id="monthTable"></tbody>
</table>
</div>

<div class="grid md:grid-cols-2 gap-4">

<div class="card">
<h3 class="font-bold mb-2">Sales vs Investment</h3>
<canvas id="salesChartCanvas"></canvas>
</div>

<div class="card">
<h3 class="font-bold mb-2">Break-even Curve</h3>
<canvas id="breakChartCanvas"></canvas>
</div>

</div>

</div>

<!-- ChartJS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- MODAL -->

<div id="modal" class="modal">
<div class="modal-box">

<h2 id="modalTitle"></h2>
<div id="modalBody" class="grid gap-2"></div>

<div class="flex gap-2 mt-3">
<button onclick="saveModal()" class="bg-blue-600 text-white px-3 py-2 rounded">Update</button>
<button onclick="deleteModal()" class="bg-red-600 text-white px-3 py-2 rounded">Delete</button>
<button onclick="closeModal()" class="bg-gray-500 text-white px-3 py-2 rounded ml-auto">Close</button>
</div>

</div>
</div>

<datalist id="nameList"></datalist>
<datalist id="designerList"></datalist>
<datalist id="supplierList"></datalist>

<script>

date.value = new Date().toISOString().split("T")[0];

let editType="", editId="";
let salesChart=null;
let breakChart=null;

let stockCache=[];

const des = document.getElementById("designerName");
const sup = document.getElementById("supplier");
const siz = document.getElementById("size");

if(des) des.value = f.designerName || "";
if(sup) sup.value = f.supplier || "";
if(siz) siz.value = f.size_ml || "";

/* ================= STOCK FIELDS ================= */

function changeFields(){

 const c = category.value;
 let html = `
 <input id="name" list="nameList"
 oninput="autoFillStock()"
 class="input" placeholder="Name">`;

 if(c==="Attar Oil"){
  html += `
  <input id="designerName" list="designerList"
  class="input" placeholder="Designer">

  <input id="supplier" list="supplierList"
  class="input" placeholder="Supplier">

  <select id="size" class="input">
   <option value="25">25 ml</option>
   <option value="50">50 ml</option>
   <option value="100">100 ml</option>
   <option value="250">250 ml</option>
   <option value="500">500 ml</option>
   <option value="1000">1000 ml</option>
  </select>`;
 }

 if(["Bottle","Pouch","Box"].includes(c)){
  html += `
  <select id="subCategory" class="input">
   <option>ECO</option>
   <option>Moderate</option>
   <option>Premium</option>
  </select>

  <select id="type" class="input">
   <option>Perfume</option>
   <option>Attar</option>
  </select>`;
 }

 html += `
 <input id="units" class="input" type="number" placeholder="Units">
 <input id="cost" class="input" type="number" placeholder="Cost">
 <input id="purchaseDate" class="input" type="date">
 `;

 dynamicFields.innerHTML = html;
}

changeFields();

/* ================= DROPDOWNS ================= */

async function loadDropdowns(){

 const stock = await (await fetch("/api/stock")).json();
 stockCache = stock;

 nameList.innerHTML =
 [...new Set(stock.map(s=>s.name).filter(Boolean))]
 .map(v=>`<option value="${v}">`).join("");

 designerList.innerHTML =
 [...new Set(stock.map(s=>s.designerName).filter(Boolean))]
 .map(v=>`<option value="${v}">`).join("");

 supplierList.innerHTML =
 [...new Set(stock.map(s=>s.supplier).filter(Boolean))]
 .map(v=>`<option value="${v}">`).join("");

 oilList.innerHTML =
 stock.filter(s=>s.category==="Attar Oil")
 .map(v=>`<option value="${v.name}">`).join("");
}

/* ================= AUTO FILL ================= */

function autoFillStock(){

 const n = name.value.toLowerCase();
 const f = stockCache.find(
 s=>(s.name||"").toLowerCase()===n
 );

 if(!f) return;

 if(designerName) designerName.value=f.designerName||"";
 if(supplier) supplier.value=f.supplier||"";
 if(size) size.value=f.size_ml||"";
}

/* ================= ADD STOCK ================= */

async function addStock(){

 const body={
  category:category.value,
  name:name?.value||"",
  designerName:designerName?.value||"",
  supplier:supplier?.value||"",
  subCategory:subCategory?.value||"",
  type:type?.value||"",
  size_ml:Number(size?.value||0),
  units:Number(units?.value||0),
  cost:Number(cost?.value||0),
  purchaseDate:purchaseDate?.value||new Date()
 };

 if(!body.name){
  stockMsg.innerText="Name required";
  return;
 }

 await fetch("/api/stock",{
  method:"POST",
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify(body)
 });

 stockMsg.innerText="Added";

 await loadDropdowns();
 loadAll();
}

/* ================= ADD SALE ================= */

function changeSaleSize(){

 saleSize.innerHTML="";

 const arr =
 saleCat.value==="Attar"
 ? [3,6,8,12,15]
 : [8,20,30,50,100];

 arr.forEach(v=>{
  saleSize.innerHTML +=
  `<option value="${v}">${v} ml</option>`;
 });
}

changeSaleSize();



function changeSaleMode(){

 saleSize.innerHTML="";

 const arr =
 saleCat.value==="Attar"
 ? [3,6,8,12,15]
 : [8,20,30,50,100];

 arr.forEach(v=>{
  saleSize.innerHTML += `<option value="${v}">${v} ml</option>`;
 });

 // hide oil % for Attar
 oilPercent.style.display =
 saleCat.value==="Attar" ? "none":"block";

 calculateMfgCost();
}

changeSaleMode();

function getAverageOilCost(name){

 const oils = stockCache.filter(s=>
 s.category==="Attar Oil" &&
 s.name===name
 );

 let totalCost=0, totalMl=0;

 oils.forEach(o=>{
  totalCost += Number(o.cost||0);
  totalMl += Number(o.size_ml||0);
 });

 return totalMl ? totalCost/totalMl : 0;
}

function getEthanolCost(){

 const e = stockCache.find(s=>
 (s.name||"").toLowerCase().includes("ethanol")
 );

 return e?.pricePerUnit || 0;
}

function getPackagingCost(){

 let cost=0;

 const bottle = stockCache.find(s=>
 s.category==="Bottle" &&
 s.subCategory===bottleCat.value
 );

 if(bottle) cost += bottle.pricePerUnit||0;

 if(boxCat.value){

  const box = stockCache.find(s=>
  s.category==="Box" &&
  s.subCategory===boxCat.value
  );

  if(box) cost += box.pricePerUnit||0;
 }

 return cost;
}


function calculateMfgCost(){

 const oilName = productName.value;
 const qty = Number(saleSize.value||0);

 if(!oilName || !qty) return;

 const oilCost = getAverageOilCost(oilName);
 const ethanolCost = getEthanolCost();

 let total=0;

 if(saleCat.value==="Perfume"){

  const oilPct =
  Number(oilPercent.value||45)/100;

  const ethanolPct = 1 - oilPct;

  total += qty*oilPct*oilCost;
  total += qty*ethanolPct*ethanolCost;

 }else{
  // ATTAR
  total += qty*oilCost;
 }

 total += getPackagingCost();
 total += Number(otherCost.value||0);

 mfg.value = total.toFixed(2);
}


async function addSale(){

 await fetch("/api/sales",{
  method:"POST",
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify({

   category:saleCat.value,
   productName:productName.value,
   size_ml:Number(saleSize.value),

   manufacturingCost:Number(mfg.value),
   soldPrice:Number(sold.value),

   customerName:customer.value,
   referenceSource:reference.value,

   saleDate:date.value
  })
 });

 loadAll();
}

/* ================= MODAL ================= */

function openModal(type,data){

 editType=type;
 editId=data._id;

 modal.style.display="flex";

 if(type==="stock"){
  modalTitle.innerText="Edit Stock";

  modalBody.innerHTML=`
  <input id="m_name" class="input" value="${data.name||""}">
  <input id="m_units" class="input" type="number" value="${data.units||0}">
  <input id="m_cost" class="input" type="number" value="${data.cost||0}">
  `;
 }else{
  modalTitle.innerText="Edit Sale";

  modalBody.innerHTML=`
  <input id="m_name" class="input" value="${data.productName||""}">
  <input id="m_customer" class="input" value="${data.customerName||""}">
  <input id="m_mfg" class="input" type="number" value="${data.manufacturingCost||0}">
  <input id="m_sold" class="input" type="number" value="${data.soldPrice||0}">
  `;
 }
}

function closeModal(){ modal.style.display="none"; }

async function saveModal(){

 let body={};

 if(editType==="stock"){
  body={
   name:m_name.value,
   units:Number(m_units.value),
   cost:Number(m_cost.value)
  };
 }

 if(editType==="sales"){
  body={
   productName:m_name.value,
   customerName:m_customer.value,
   manufacturingCost:Number(m_mfg.value),
   soldPrice:Number(m_sold.value)
  };
 }

 await fetch(`/api/${editType}/${editId}`,{
  method:"PUT",
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify(body)
 });

 closeModal();
 loadAll();
}

/* ================= LOAD DATA ================= */

async function loadAll(){

 const stock = await (await fetch("/api/stock")).json();
 const sales = await (await fetch("/api/sales")).json();
 const dash = await (await fetch("/api/dashboard")).json();

 investment.innerText=dash.totalInvestment.toFixed(2);
 sales.innerText=dash.totalSales.toFixed(2);
 profit.innerText=dash.totalProfit.toFixed(2);
 roi.innerText=dash.roi.toFixed(2);

stockTable.innerHTML = stock.map(s=>`
<tr onclick="openModal('stock',${JSON.stringify(s).replace(/"/g,'&quot;')})">
 <td>${s.name||""}</td>
 <td>${s.category||""}</td>
 <td>${s.units||0}</td>
 <td>${s.cost||0}</td>
 </tr>`).join("");

 salesTable.innerHTML = sales.map(s=>`
 <tr onclick='openModal("sales",${JSON.stringify(s)})'>
 <td>${s.productName||""}</td>
 <td>${s.customerName||""}</td>
 <td>${s.profit?.toFixed(2)||0}</td>
 </tr>`).join("");

 loadAnalytics(stock,sales);
}

/* ================= ANALYTICS ================= */

function loadAnalytics(stock,sales){

 const months={};

 stock.forEach(s=>{
  const d = s.purchaseDate ? new Date(s.purchaseDate) : new Date();
  const k=d.getFullYear()+"-"+(d.getMonth()+1);
  if(!months[k]) months[k]={investment:0,sales:0,profit:0};
  months[k].investment+=Number(s.cost||0);
 });

 sales.forEach(s=>{
  const d=new Date(s.saleDate||Date.now());
  const k=d.getFullYear()+"-"+(d.getMonth()+1);
  if(!months[k]) months[k]={investment:0,sales:0,profit:0};
  months[k].sales+=Number(s.soldPrice||0);
  months[k].profit+=Number(s.profit||0);
 });

 const labels=Object.keys(months).sort();

 const inv=labels.map(m=>months[m].investment);
 const sal=labels.map(m=>months[m].sales);

 monthTable.innerHTML=labels.map(m=>`
 <tr>
 <td>${m}</td>
 <td>${months[m].investment.toFixed(2)}</td>
 <td>${months[m].sales.toFixed(2)}</td>
 <td>${months[m].profit.toFixed(2)}</td>
 <td>${months[m].investment? (months[m].sales/months[m].investment).toFixed(2):0}</td>
 </tr>`).join("");

 if(salesChart) salesChart.destroy();

 salesChart=new Chart(salesChartCanvas,{
  type:"bar",
  data:{labels,datasets:[
   {label:"Investment",data:inv},
   {label:"Sales",data:sal}
  ]}
 });

 let a=0,b=0;
 const cumInv=[], cumSal=[];

 labels.forEach((m,i)=>{
  a+=inv[i]; b+=sal[i];
  cumInv.push(a); cumSal.push(b);
 });

 if(breakChart) breakChart.destroy();

 breakChart=new Chart(breakChartCanvas,{
  type:"line",
  data:{labels,datasets:[
   {label:"Cumulative Investment",data:cumInv},
   {label:"Cumulative Sales",data:cumSal}
  ]}
 });
}

/* ================= INIT ================= */

loadDropdowns();
loadAll();

</script>

</body>
</html>