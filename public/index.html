<!DOCTYPE html>
<html lang="en">
<head>
    <title>Perfume ERP PRO | Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.07);
        }
        .input-focus {
            transition: all 0.2s;
        }
        .input-focus:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            outline: none;
        }
        .modal {
            position: fixed; inset: 0;
            background: rgba(15, 23, 42, 0.7);
            display: none; justify-content: center; align-items: center;
            z-index: 50;
        }
        tr:hover { background: #f8fafc; cursor: pointer; transition: background 0.2s; }
        .nav-link.active {
            border-bottom: 2px solid #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen pb-12">

<nav class="bg-white border-b sticky top-0 z-40 px-4 py-3 mb-6">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="bg-indigo-600 p-1.5 rounded-lg">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
            </div>
            <h1 class="text-xl font-bold text-slate-800 tracking-tight">Perfume ERP <span class="text-indigo-600">PRO</span></h1>
        </div>
        <button onclick="logout()" class="text-sm font-medium text-red-500 hover:bg-red-50 px-4 py-2 rounded-lg transition">
            Logout
        </button>
    </div>
</nav>

<main class="max-w-7xl mx-auto px-4">
    
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="glass-card p-5 rounded-2xl border-l-4 border-blue-500">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Investment</p>
            <p id="investment" class="text-2xl font-bold text-slate-800 mt-1">â‚¹0</p>
        </div>
        <div class="glass-card p-5 rounded-2xl border-l-4 border-emerald-500">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Sales</p>
            <p id="sales" class="text-2xl font-bold text-slate-800 mt-1">â‚¹0</p>
        </div>
        <div class="glass-card p-5 rounded-2xl border-l-4 border-indigo-500">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Profit</p>
            <p id="profit" class="text-2xl font-bold text-emerald-600 mt-1">â‚¹0</p>
        </div>
        <div class="glass-card p-5 rounded-2xl border-l-4 border-amber-500">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider">ROI</p>
            <p id="roi" class="text-2xl font-bold text-slate-800 mt-1">0</p>
        </div>
    </div>

    <div class="flex gap-6 border-b mb-6 overflow-x-auto">
        <button onclick="showTab('inventory')" id="tab-inventory" class="nav-link active pb-3 px-1 transition-all whitespace-nowrap">Inventory Stock</button>
        <button onclick="showTab('sales-entry')" id="tab-sales-entry" class="nav-link pb-3 px-1 transition-all whitespace-nowrap">Sales & Billing</button>
        <button onclick="showTab('analytics')" id="tab-analytics" class="nav-link pb-3 px-1 transition-all whitespace-nowrap">Business Analytics</button>
    </div>

    <div id="inventory" class="tab-content active space-y-6">
        <div class="grid lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 glass-card p-6 rounded-2xl h-fit">
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="2" stroke-linecap="round"/></svg>
                    New Stock Entry
                </h2>
                <div class="space-y-3">
                    <label class="block text-sm font-medium text-slate-600">Category</label>
                    <select id="category" onchange="changeFields()" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus">
                        <option>Attar Oil</option>
                        <option>Raw Perfume</option>
                        <option>Bottle</option>
                        <option>Pouch</option>
                        <option>Box</option>
                        <option>Aroma Chemical</option>
                        <option>Equipment</option>
                        <option>Misc</option>
                    </select>
                    <div id="dynamicFields" class="space-y-3 mt-4"></div>
                    
                    <button onclick="addStock()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-xl transition shadow-lg shadow-indigo-200 mt-4">
                        Add to Inventory
                    </button>
                    <p id="stockMsg" class="text-center text-sm font-medium text-emerald-600"></p>
                </div>
            </div>

            <div class="lg:col-span-2 glass-card p-6 rounded-2xl">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                    <h2 class="text-lg font-bold text-slate-800">Stock Records</h2>
                    <input id="stockFilter" class="p-2 border rounded-lg text-sm w-full sm:w-64 bg-slate-50" placeholder="ðŸ” Search stock..." oninput="loadAll()">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead>
                            <tr class="text-slate-500 border-b">
                                <th class="pb-3 font-semibold">Product Name</th>
                                <th class="pb-3 font-semibold">Category</th>
                                <th class="pb-3 font-semibold text-right">Units</th>
                                <th class="pb-3 font-semibold text-right">Cost</th>
                                
                            </tr>
                        </thead>
                        <tbody id="stockTable" class="divide-y"></tbody>
                    </table>
                </div>
                <div class="mt-4 pt-4 border-t flex justify-between items-center">
                    <span class="text-slate-500 font-medium">Total Inventory Value:</span>
                    <span class="text-lg font-bold text-indigo-600">â‚¹ <span id="stockTotal">0</span></span>
                </div>
            </div>
        </div>
    </div>

    <div id="sales-entry" class="tab-content space-y-6">
        <div class="grid lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 glass-card p-6 rounded-2xl h-fit">
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    New Sale
                </h2>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <select id="saleCat" class="p-2.5 border rounded-xl bg-slate-50 input-focus" onchange="changeSaleMode()">
                            <option value="Perfume">Perfume</option>
                            <option value="Attar">Attar</option>
                        </select>
                        <select id="saleSize" class="p-2.5 border rounded-xl bg-slate-50 input-focus" onchange="calculateMfgCost()"></select>
                    </div>
                    
                    <input id="productName" list="oilList" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus" placeholder="Attar Oil Name" oninput="calculateMfgCost()">
                    
                    <div class="grid grid-cols-2 gap-2">
                        <input id="oilPercent" class="p-2.5 border rounded-xl bg-slate-50 input-focus" type="number" value="45" placeholder="Oil %" oninput="calculateMfgCost()">
                        <input id="otherCost" type="number" class="p-2.5 border rounded-xl bg-slate-50 input-focus" placeholder="Misc Cost" oninput="calculateMfgCost()">
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] uppercase font-bold text-slate-400">Packaging (Bottle / Box / Pouch)</label>
                        <div class="grid grid-cols-3 gap-1">
                            <select id="bottleCat" class="text-xs p-2 border rounded-lg bg-slate-50" onchange="calculateMfgCost()">
                                <option value="NA">Bottle (NA)</option><option>ECO</option><option>Moderate</option><option>Premium</option>
                            </select>
                            <select id="boxCat" class="text-xs p-2 border rounded-lg bg-slate-50" onchange="calculateMfgCost()">
                                <option value="NA">Box (NA)</option><option>ECO</option><option>Moderate</option><option>Premium</option>
                            </select>
                            <select id="pouchCat" class="text-xs p-2 border rounded-lg bg-slate-50" onchange="calculateMfgCost()">
                                <option value="NA">Pouch (NA)</option><option>ECO</option><option>Moderate</option><option>Premium</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-indigo-50 p-3 rounded-xl border border-indigo-100">
                        <label class="text-xs font-bold text-indigo-400 uppercase">Est. Mfg Cost (Editable)</label>
                        <input id="mfg" type="number" step="0.01" class="w-full bg-transparent text-xl font-bold text-indigo-700 outline-none" value="0.00">
                    </div>

                    <input id="sold" class="w-full p-2.5 border border-emerald-200 rounded-xl bg-emerald-50 input-focus font-bold" type="number" placeholder="Selling Price â‚¹">
                    
                    <div class="grid grid-cols-2 gap-2">
                        <input id="customer" class="p-2.5 border rounded-xl bg-slate-50 input-focus" placeholder="Customer">
                        <input id="reference" class="p-2.5 border rounded-xl bg-slate-50 input-focus" placeholder="Reference">
                    </div>
                    <input id="date" type="date" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus">

                    <button onclick="addSale()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 rounded-xl transition shadow-lg shadow-emerald-200 mt-2">
                        Complete Sale
                    </button>
                </div>
            </div>

            <div class="lg:col-span-2 glass-card p-6 rounded-2xl">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                    <h2 class="text-lg font-bold text-slate-800">Sales History</h2>
                    <input id="salesFilter" class="p-2 border rounded-lg text-sm w-full sm:w-64 bg-slate-50" placeholder="ðŸ” Search sales..." oninput="loadAll()">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead>
                            <tr class="text-slate-500 border-b">
                                <th class="pb-3 font-semibold">Product</th>
                                <th class="pb-3 font-semibold">Customer</th>
                                <th class="pb-3 font-semibold text-right">Profit</th>
                            </tr>
                        </thead>
                        <tbody id="salesTable" class="divide-y"></tbody>
                    </table>
                </div>
                <div class="mt-4 pt-4 border-t flex justify-between items-center">
                    <span class="text-slate-500 font-medium">Total Sales Revenue:</span>
                    <span class="text-lg font-bold text-emerald-600">â‚¹ <span id="salesTotal">0</span></span>
                </div>
            </div>
        </div>
    </div>

    <div id="analytics" class="tab-content space-y-6">
        <div class="glass-card p-6 rounded-2xl">
            <div class="flex flex-wrap gap-4 items-center mb-6">
                <h2 class="text-lg font-bold text-slate-800 mr-auto">Monthly Performance</h2>
                <select id="yearSelect" class="p-2 border rounded-lg text-sm bg-white" onchange="loadAll()">
                    <option value="ALL">All Years</option>
                </select>
                <select id="rangeSelect" class="p-2 border rounded-lg text-sm bg-white" onchange="loadAll()">
                    <option value="ALL">Lifetime</option>
                    <option value="1Y">1 Year</option>
                    <option value="6M">6 Months</option>
                    <option value="3M">3 Months</option>
                    <option value="1M">1 Month</option>
                    <option value="7D">7 Days</option>
                </select>
            </div>

            <div class="overflow-x-auto rounded-xl border mb-8">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 text-slate-600 border-b">
                        <tr>
                            <th class="p-4 font-semibold">Month</th>
                            <th class="p-4 font-semibold">Investment</th>
                            <th class="p-4 font-semibold">Sales</th>
                            <th class="p-4 font-semibold">Profit</th>
                            <th class="p-4 font-semibold">ROI</th>
                        </tr>
                    </thead>
                    <tbody id="monthTable" class="divide-y"></tbody>
                </table>
            </div>

            <div class="grid lg:grid-cols-2 gap-8">
                <div class="p-4 bg-white border rounded-2xl shadow-sm">
                    <h3 class="text-sm font-bold text-slate-500 mb-4 uppercase">Sales vs Investment</h3>
                    <canvas id="salesChartCanvas"></canvas>
                </div>
                <div class="p-4 bg-white border rounded-2xl shadow-sm">
                    <h3 class="text-sm font-bold text-slate-500 mb-4 uppercase">Break-even Curve</h3>
                    <canvas id="breakChartCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

</main>

<div id="modal" class="modal">
    <div class="bg-white rounded-2xl shadow-2xl w-[95%] max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
        <div class="p-6 border-b">
            <h2 id="modalTitle" class="text-xl font-bold text-slate-800">Edit Entry</h2>
        </div>
        <div id="modalBody" class="p-6 grid gap-4"></div>
        <div class="p-6 bg-slate-50 flex gap-3">
            <button onclick="saveModal()" class="flex-1 bg-indigo-600 text-white py-2 rounded-xl font-semibold hover:bg-indigo-700 transition">Update</button>
            <button onclick="deleteModal()" class="flex-1 bg-red-100 text-red-600 py-2 rounded-xl font-semibold hover:bg-red-200 transition">Delete</button>
            <button onclick="closeModal()" class="px-4 py-2 text-slate-500 font-medium">Cancel</button>
        </div>
    </div>
</div>

<datalist id="oilList"></datalist>
<datalist id="nameList"></datalist>
<datalist id="designerList"></datalist>
<datalist id="supplierList"></datalist>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // TAB FLOW LOGIC
    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.getElementById('tab-' + tabId).classList.add('active');
    }

    async function checkAuth(){
        const r = await fetch("/api/check-auth");
        const d = await r.json();
        if(!d.authenticated) window.location.href="/login.html";
    }
    checkAuth();

    document.getElementById('date').value = new Date().toISOString().split("T")[0];

    let stockCache=[];
    let editType="",editId="";
    let salesChart=null;
    let breakChart=null;

    function changeFields(){
        const c=category.value;
        let html=`<input id="name" list="nameList" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus" placeholder="Item Name" oninput="autoFillStock()">`;

        // Filter datalist for names based on category selected
        updateNameList(c);

        if(c==="Attar Oil"){
            html+=`
            <input id="designerName" list="designerList" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus" placeholder="Designer Name">
            <input id="supplier" list="supplierList" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus" placeholder="Supplier">
            <select id="size" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus">
                <option value="25">25 ml</option><option value="50">50 ml</option><option value="100">100 ml</option>
                <option value="250">250 ml</option><option value="500">500 ml</option><option value="1000">1000 ml</option>
            </select>`;
        }

        if(["Bottle","Pouch","Box"].includes(c)){
            html+=`
            <select id="subCategory" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus">
                <option value="">Quality: NA</option><option>ECO</option><option>Moderate</option><option>Premium</option>
            </select>
            <select id="type" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus">
                <option>Perfume</option><option>Attar</option>
            </select>`;
        }

        // standard quantity and cost fields for all including Raw Perfume and Chemicals
        html+=`
        <div class="grid grid-cols-2 gap-2">
            <input id="units" type="number" class="p-2.5 border rounded-xl bg-slate-50 input-focus" placeholder="Quantity/Units">
            <input id="cost" type="number" class="p-2.5 border rounded-xl bg-slate-50 input-focus" placeholder="Total Cost">
        </div>
        <div class="space-y-1">
            <label class="text-[10px] uppercase font-bold text-slate-400">Purchase Date</label>
            <input id="stockPurchaseDate" type="date" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus">
        </div>`;
        
        dynamicFields.innerHTML=html;
        document.getElementById('stockPurchaseDate').value = new Date().toISOString().split("T")[0];
    }

    function updateNameList(selectedCategory) {
        // Only show names matching the selected category and remove duplicates
        const filteredNames = [...new Set(stockCache
            .filter(s => s.category === selectedCategory)
            .map(s => s.name))]
            .filter(Boolean);
        nameList.innerHTML = filteredNames.map(v => `<option value="${v}">`).join("");
    }

    async function loadDropdowns(){
        try {
            const stock=await (await fetch("/api/stock")).json();
            stockCache=stock;
            
            // Deduplicate lists
            designerList.innerHTML=[...new Set(stock.map(s=>s.designerName))].filter(Boolean).map(v=>`<option value="${v}">`).join("");
            supplierList.innerHTML=[...new Set(stock.map(s=>s.supplier))].filter(Boolean).map(v=>`<option value="${v}">`).join("");
            
            // Sales dropdown: ONLY Attar Oils, deduplicated
            oilList.innerHTML=[...new Set(stock.filter(s=>s.category==="Attar Oil").map(o=>o.name))].map(v=>`<option value="${v}">`).join("");
            
            // Refresh current stock entry list
            updateNameList(category.value);
        } catch(e) { console.error("Dropdown load failed", e); }
    }

    function autoFillStock(){
        const currentCat = category.value;
        const itemName = document.getElementById('name').value;
        const f=stockCache.find(s=>s.name===itemName && s.category === currentCat);
        if(!f) return;
        
        const dn = document.getElementById('designerName');
        const sp = document.getElementById('supplier');
        const sz = document.getElementById('size');
        const sub = document.getElementById('subCategory');
        const typ = document.getElementById('type');

        if(dn) dn.value = f.designerName || "";
        if(sp) sp.value = f.supplier || "";
        if(sz) sz.value = f.size_ml || "";
        if(sub) sub.value = f.subCategory || "";
        if(typ) typ.value = f.type || "";
    }

    function calculateMfgCost(){
        const oil = stockCache.find(s => s.name === productName.value && s.category === "Attar Oil");
        if(!oil) return;
        const qty = Number(saleSize.value || 0);
        const oilPercentVal = Number(oilPercent.value || 0);
        const bottleCategory = bottleCat.value;
        const boxCategory = boxCat.value;
        const pouchCategory = pouchCat.value;
        const extraCost = Number(otherCost.value || 0);

        let totalCost = 0;

        if(saleCat.value === "Attar"){
            const oilCost = oil.pricePerUnit || 0;
            totalCost += oilCost * qty;
        }

        if(saleCat.value === "Perfume"){
            const oilCostPerMl = oil.pricePerUnit || 0;
            const oilQty = qty * (oilPercentVal / 100);
            const ethanolQty = qty - oilQty;
            const ethanolStock = stockCache.find(s => s.name?.toLowerCase().includes("ethanol"));
            const ethanolCostPerMl = ethanolStock ? ethanolStock.pricePerUnit : 0;
            totalCost += (oilQty * oilCostPerMl) + (ethanolQty * ethanolCostPerMl);
        }

        if(bottleCategory !== "NA"){
            const b = stockCache.find(s => s.category === "Bottle" && s.subCategory === bottleCategory && s.type === saleCat.value);
            if(b) totalCost += b.pricePerUnit || 0;
        }
        if(boxCategory !== "NA"){
            const b = stockCache.find(s => s.category === "Box" && s.subCategory === boxCategory);
            if(b) totalCost += b.pricePerUnit || 0;
        }
        if(pouchCategory !== "NA"){
            const p = stockCache.find(s => s.category === "Pouch" && s.subCategory === pouchCategory);
            if(p) totalCost += p.pricePerUnit || 0;
        }

        totalCost += extraCost;
        mfg.value = totalCost.toFixed(2);
    }

    function changeSaleMode(){
        const type = saleCat.value;
        saleSize.innerHTML = "";
        if(type === "Attar"){
            [3,6,8,12,15].forEach(v=>{ saleSize.innerHTML += `<option value="${v}">${v} ml</option>`; });
            oilPercent.style.display = "none";
        } else {
            [8,20,30,50,100].forEach(v=>{ saleSize.innerHTML += `<option value="${v}">${v} ml</option>`; });
            oilPercent.style.display = "block";
        }
        calculateMfgCost();
    }

    async function addStock(){
        const body={
            category:category.value,
            name:document.getElementById("name")?.value||"",
            designerName:document.getElementById("designerName")?.value||"",
            supplier:document.getElementById("supplier")?.value||"",
            subCategory:document.getElementById("subCategory")?.value||"",
            type:document.getElementById("type")?.value||"",
            size_ml:Number(document.getElementById("size")?.value||0),
            units:Number(document.getElementById("units")?.value||0),
            cost:Number(document.getElementById("cost")?.value||0),
            purchaseDate: document.getElementById("stockPurchaseDate")?.value || new Date().toISOString().split("T")[0]
        };
        await fetch("/api/stock",{
            method:"POST",
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(body)
        });
        stockMsg.innerText = "Stock added successfully!";
        setTimeout(()=>stockMsg.innerText="", 2000);
        loadAll(); loadDropdowns();
    }

    async function addSale(){
        await fetch("/api/sales",{
            method:"POST",
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                productName:productName.value,
                customerName:customer.value,
                referenceSource:reference.value,
                manufacturingCost:Number(mfg.value||0),
                soldPrice:Number(sold.value||0),
                saleDate:date.value
            })
        });
        loadAll();
    }

    function openModal(type,data){
        editType=type; editId=data._id;
        modal.style.display="flex";
        modalTitle.innerText=type==="stock"?"Edit Stock Item":"Edit Sale Record";

        if(type==="stock"){
            modalBody.innerHTML=`
                <input id="m_name" placeholder="Name" class="p-2 border rounded-xl bg-slate-50" value="${data.name||""}">
                <input id="m_designer" placeholder="Designer" class="p-2 border rounded-xl bg-slate-50" value="${data.designerName||""}">
                <input id="m_supplier" placeholder="Supplier" class="p-2 border rounded-xl bg-slate-50" value="${data.supplier||""}">
                <div class="grid grid-cols-2 gap-2">
                    <input id="m_units" placeholder="Units" class="p-2 border rounded-xl bg-slate-50" type="number" value="${data.units||0}">
                    <input id="m_cost" placeholder="Cost" class="p-2 border rounded-xl bg-slate-50" type="number" value="${data.cost||0}">
                </div>`;
        } else {
            modalBody.innerHTML=`
                <input id="m_name" placeholder="Product" class="p-2 border rounded-xl bg-slate-50" value="${data.productName||""}">
                <input id="m_customer" placeholder="Customer" class="p-2 border rounded-xl bg-slate-50" value="${data.customerName||""}">
                <div class="grid grid-cols-2 gap-2">
                    <input id="m_mfg" placeholder="Mfg Cost" class="p-2 border rounded-xl bg-slate-50" type="number" value="${data.manufacturingCost||0}">
                    <input id="m_sold" placeholder="Sold Price" class="p-2 border rounded-xl bg-slate-50" type="number" value="${data.soldPrice||0}">
                </div>`;
        }
    }

    function closeModal(){ modal.style.display="none"; }

    async function saveModal(){
        let body={};
        if(editType==="stock"){
            body={ name:m_name.value, designerName:m_designer.value, supplier:m_supplier.value, units:Number(m_units.value), cost:Number(m_cost.value) };
        } else {
            body={ productName:m_name.value, customerName:m_customer.value, manufacturingCost:Number(m_mfg.value), soldPrice:Number(m_sold.value) };
        }
        await fetch(`/api/${editType}/${editId}`,{
            method:"PUT", headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
        });
        closeModal(); loadAll();
    }

    async function deleteModal(){
        if(confirm("Are you sure you want to delete this?")){
            await fetch(`/api/${editType}/${editId}`,{method:"DELETE"});
            closeModal(); loadAll();
        }
    }

    function buildAnalytics(stock, salesData){
        const months = {}; const now = new Date();
        const selectedYear = yearSelect.value;
        const selectedRange = rangeSelect.value;

        function inRange(date){
            if(selectedYear !== "ALL" && date.getFullYear().toString() !== selectedYear) return false;
            if(selectedRange === "ALL") return true;
            const diff = now - date; const day = 1000*60*60*24;
            if(selectedRange==="7D") return diff <= 7*day;
            if(selectedRange==="1M") return diff <= 30*day;
            if(selectedRange==="3M") return diff <= 90*day;
            if(selectedRange==="6M") return diff <= 180*day;
            if(selectedRange==="1Y") return diff <= 365*day;
            return true;
        }

        stock.forEach(s=>{
            const d=new Date(s.purchaseDate || s._id.substring(0,8)*1000);
            if(!inRange(d)) return;
            const key=d.toLocaleString("default",{month:"short",year:"numeric"});
            if(!months[key]) months[key]={investment:0,sales:0,profit:0};
            months[key].investment+=Number(s.cost||0);
        });

        salesData.forEach(s=>{
            const d=new Date(s.saleDate||Date.now());
            if(!inRange(d)) return;
            const key=d.toLocaleString("default",{month:"short",year:"numeric"});
            if(!months[key]) months[key]={investment:0,sales:0,profit:0};
            months[key].sales+=Number(s.soldPrice||0);
            months[key].profit+=Number(s.profit||0);
        });

        const labels = Object.keys(months).sort((a,b)=> new Date(a) - new Date(b));

        monthTable.innerHTML = labels.map(m=>{
            const x=months[m]; const roi = x.investment ? (x.profit/x.investment).toFixed(2) : "0.00";
            return `<tr><td class="p-4">${m}</td><td class="p-4 font-medium">â‚¹${x.investment.toFixed(2)}</td><td class="p-4 font-medium">â‚¹${x.sales.toFixed(2)}</td><td class="p-4 font-bold text-emerald-600">â‚¹${x.profit.toFixed(2)}</td><td class="p-4 font-bold">${roi}</td></tr>`;
        }).join("");

        if(salesChart) salesChart.destroy();
        salesChart = new Chart(salesChartCanvas,{
            type:"bar", data:{ labels, datasets:[ {label:"Investment",data:labels.map(m=>months[m].investment), backgroundColor:'#818cf8'}, {label:"Sales",data:labels.map(m=>months[m].sales), backgroundColor:'#10b981'} ] },
            options:{ responsive:true, plugins:{ legend:{position:"top"} } }
        });

        let cumInv=0, cumSales=0; const invArr=[], salesArr=[];
        labels.forEach(m=>{ cumInv+=months[m].investment; cumSales+=months[m].sales; invArr.push(cumInv); salesArr.push(cumSales); });

        if(breakChart) breakChart.destroy();
        breakChart = new Chart(breakChartCanvas,{
            type:"line", data:{ labels, datasets:[ {label:"Cum. Investment",data:invArr, borderColor:'#f59e0b', tension:0.3}, {label:"Cum. Sales",data:salesArr, borderColor:'#6366f1', tension:0.3} ] },
            options:{ responsive:true }
        });
    }

    async function logout(){ await fetch("/api/logout",{method:"POST"}); window.location.href="/login.html"; }

    async function loadAll(){
        const stock=await (await fetch("/api/stock")).json();
        const salesData=await (await fetch("/api/sales")).json();
        const dash=await (await fetch("/api/dashboard")).json();

        investment.innerText="â‚¹" + dash.totalInvestment.toLocaleString();
        document.getElementById("sales").innerText="â‚¹" + dash.totalSales.toLocaleString();
        profit.innerText="â‚¹" + dash.totalProfit.toLocaleString();
        roi.innerText=dash.roi.toFixed(2);

        const sf=stockFilter.value?.toLowerCase()||"";
        const fStock=stock.filter(s=>(s.name||"").toLowerCase().includes(sf));
        stockTable.innerHTML=fStock.map(s=>`
            <tr onclick='openModal("stock",${JSON.stringify(s).replace(/"/g,"&quot;")})'>
                <td class="py-3 font-medium">${s.name||""}</td><td class="py-3 text-slate-500">${s.category||""}</td>
                <td class="py-3 text-right font-mono">${s.units||0}</td><td class="py-3 text-right font-bold">â‚¹${s.cost||0}</td>
            </tr>`).join("");
        stockTotal.innerText=fStock.reduce((a,b)=>a+(b.cost||0),0).toFixed(2);

        const salef=salesFilter.value?.toLowerCase()||"";
        const fSales=salesData.filter(s=>(s.productName||"").toLowerCase().includes(salef));
        salesTable.innerHTML=fSales.map(s=>`
            <tr onclick='openModal("sales",${JSON.stringify(s).replace(/"/g,"&quot;")})'>
                <td class="py-3 font-medium">${s.productName||""}</td><td class="py-3 text-slate-500">${s.customerName||""}</td>
                <td class="py-3 text-right font-bold text-emerald-600">â‚¹${s.profit?.toFixed(2)||0}</td>
            </tr>`).join("");
        salesTotal.innerText=fSales.reduce((a,b)=>a+(b.soldPrice||0),0).toFixed(2);

        const years = [...new Set(salesData.map(s=>new Date(s.saleDate).getFullYear()))];
        yearSelect.innerHTML = `<option value="ALL">All Years</option>` + years.map(y=>`<option value="${y}">${y}</option>`).join("");
        
        stockCache = stock; // update local cache
        buildAnalytics(stock,salesData);
    }

    loadDropdowns(); loadAll(); changeSaleMode();
</script>
</body>
</html>