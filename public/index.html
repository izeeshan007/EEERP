<!DOCTYPE html>
<html lang="en">
<head>
    <title>Perfume ERP | Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.07);
            transition: transform 0.2s;
        }
        .clickable-card:hover { transform: translateY(-2px); cursor: pointer; border-color: #6366f1; }
        .input-focus { transition: all 0.2s; }
        .input-focus:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            outline: none;
        }
        .modal {
            position: fixed; inset: 0;
            background: rgba(15, 23, 42, 0.7);
            display: none; justify-content: center; align-items: center;
            z-index: 50;
        }
        tr.sales-row:hover, #stockRecordsTable tr:hover, #invoicesRecordsTable tr:hover { background: #f8fafc; cursor: pointer; transition: background 0.2s; }
        .nav-link.active {
            border-bottom: 2px solid #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .sort-header { cursor: pointer; user-select: none; }
        .sort-header:hover { color: #4f46e5; }
        .filter-input {
            width: 100%;
            padding: 4px 8px;
            font-size: 11px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            background: #fff;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen pb-12">

<nav class="bg-white border-b sticky top-0 z-40 px-4 py-3 mb-6">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="bg-indigo-600 p-1.5 rounded-lg">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
            </div>
            <h1 class="text-xl font-bold text-slate-800 tracking-tight">Perfume ERP <span class="text-indigo-600">V1.2</span></h1>
        </div>
        <button onclick="logout()" class="text-sm font-medium text-red-500 hover:bg-red-50 px-4 py-2 rounded-lg transition">Logout</button>
    </div>
</nav>

<main class="max-w-7xl mx-auto px-4">
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 mb-8">
        <div class="glass-card p-4 rounded-2xl border-l-4 border-blue-500">
            <p class="text-[10px] font-semibold text-slate-500 uppercase tracking-wider">Investment</p>
            <p id="investment" class="text-lg font-bold text-slate-800 mt-1">₹0</p>
        </div>
        <div class="glass-card p-4 rounded-2xl border-l-4 border-emerald-500">
            <p class="text-[10px] font-semibold text-slate-500 uppercase tracking-wider">Sales</p>
            <p id="sales" class="text-lg font-bold text-slate-800 mt-1">₹0</p>
        </div>
        <div class="glass-card p-4 rounded-2xl border-l-4 border-indigo-500">
            <p class="text-[10px] font-semibold text-slate-500 uppercase tracking-wider">Profit</p>
            <p id="profit" class="text-lg font-bold text-emerald-600 mt-1">₹0</p>
        </div>
        <div class="glass-card p-4 rounded-2xl border-l-4 border-rose-500" id="net-pl-card">
            <p class="text-[10px] font-semibold text-slate-500 uppercase tracking-wider">Net P/L</p>
            <p id="net-pl" class="text-lg font-bold mt-1">₹0</p>
        </div>
        <div class="glass-card p-4 rounded-2xl border-l-4 border-cyan-500">
            <p class="text-[10px] font-semibold text-slate-500 uppercase tracking-wider">B.Even %</p>
            <p id="breakeven" class="text-lg font-bold text-slate-800 mt-1">0%</p>
        </div>
        <div class="glass-card p-4 rounded-2xl border-l-4 border-amber-500">
            <p class="text-[10px] font-semibold text-slate-500 uppercase tracking-wider">ROI</p>
            <p id="roi" class="text-lg font-bold text-slate-800 mt-1">0</p>
        </div>
        <div onclick="filterSalesStatus('undelivered')" class="glass-card clickable-card p-4 rounded-2xl border-l-4 border-orange-500 bg-orange-50/30">
            <p class="text-[10px] font-bold text-orange-600 uppercase tracking-wider">Pending Delivery</p>
            <p id="count-undelivered" class="text-xl font-black text-orange-700 mt-1">0</p>
        </div>
        <div onclick="filterSalesStatus('unpaid')" class="glass-card clickable-card p-4 rounded-2xl border-l-4 border-red-500 bg-red-50/30">
            <p class="text-[10px] font-bold text-red-600 uppercase tracking-wider">Unpaid Sales</p>
            <p id="count-unpaid" class="text-xl font-black text-red-700 mt-1">0</p>
        </div>
    </div>

    <div class="flex gap-6 border-b mb-6 overflow-x-auto">
        <button onclick="showTab('inventory')" id="tab-inventory" class="nav-link active pb-3 px-1 transition-all whitespace-nowrap">Inventory Stock</button>
        <button onclick="showTab('sales-entry')" id="tab-sales-entry" class="nav-link pb-3 px-1 transition-all whitespace-nowrap">Sales & Billing</button>
        <button onclick="showTab('invoices')" id="tab-invoices" class="nav-link pb-3 px-1 transition-all whitespace-nowrap">Invoices</button>
        <button onclick="showTab('analytics')" id="tab-analytics" class="nav-link pb-3 px-1 transition-all whitespace-nowrap">Business Analytics</button>
    </div>

    <div id="inventory" class="tab-content active space-y-6">
        <div class="grid lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 glass-card p-6 rounded-2xl h-fit">
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="2" stroke-linecap="round"/></svg>
                    New Stock Entry
                </h2>
                <div class="space-y-3">
                    <label class="block text-sm font-medium text-slate-600">Category</label>
                    <select id="category" onchange="changeFields()" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus">
                        <option>Attar Oil</option>
                        <option>Raw Perfume</option>
                        <option>Bottle</option>
                        <option>Pouch</option>
                        <option>Box</option>
                        <option>Aroma Chemical</option>
                        <option>Equipment</option>
                        <option>Misc</option>
                    </select>
                    <div id="dynamicFields" class="space-y-3 mt-4"></div>
                    <button onclick="addStock()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-xl transition shadow-lg shadow-indigo-200 mt-4">Add to Inventory</button>
                    <p id="stockMsg" class="text-center text-sm font-medium text-emerald-600"></p>
                </div>
            </div>

            <div class="lg:col-span-2 glass-card p-6 rounded-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-slate-800">Stock Records</h2>
                    <button onclick="clearFilters('stock')" class="text-xs text-indigo-600 hover:underline">Clear Filters</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm" id="stockRecordsTable">
                        <thead>
                            <tr class="text-slate-500 border-b">
                                <th class="pb-2 font-semibold sort-header" onclick="setSort('stock', 'name')">Name ↕</th>
                                <th class="pb-2 font-semibold sort-header" onclick="setSort('stock', 'category')">Category ↕</th>
                                <th class="pb-2 font-semibold text-right sort-header" onclick="setSort('stock', 'units')">Qty/Size ↕</th>
                                <th class="pb-2 font-semibold text-right sort-header" onclick="setSort('stock', 'cost')">Cost ↕</th>
                            </tr>
                            <tr class="bg-slate-50/50">
                                <th class="py-2 pr-2"><input type="text" id="filter-stock-name" class="filter-input" placeholder="Filter name..." oninput="renderStockTable()"></th>
                                <th class="py-2 pr-2">
                                    <select id="filter-stock-category" class="filter-input" onchange="renderStockTable()">
                                        <option value="">All Categories</option>
                                        <option>Attar Oil</option><option>Raw Perfume</option><option>Bottle</option>
                                        <option>Pouch</option><option>Box</option><option>Aroma Chemical</option>
                                        <option>Equipment</option><option>Misc</option>
                                    </select>
                                </th>
                                <th class="py-2"></th>
                                <th class="py-2"></th>
                            </tr>
                        </thead>
                        <tbody id="stockTable" class="divide-y"></tbody>
                    </table>
                </div>
                <div class="mt-4 pt-4 border-t flex justify-between items-center">
                    <span class="text-slate-500 font-medium">Filtered Value:</span>
                    <span class="text-lg font-bold text-indigo-600">₹ <span id="stockTotal">0</span></span>
                </div>
            </div>
        </div>
    </div>

    <div id="sales-entry" class="tab-content space-y-6">
        <div class="grid lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 glass-card p-6 rounded-2xl h-fit">
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    New Sale
                </h2>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <select id="saleCat" class="p-2.5 border rounded-xl bg-slate-50 input-focus" onchange="changeSaleMode()">
                            <option value="Perfume">Perfume</option>
                            <option value="Attar">Attar</option>
                        </select>
                        <select id="saleSize" class="p-2.5 border rounded-xl bg-slate-50 input-focus" onchange="calculateMfgCost()"></select>
                    </div>
                    <input id="productName" list="oilList" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus" placeholder="Attar Oil Name" oninput="calculateMfgCost()">
                    
                    <div class="grid grid-cols-3 gap-2">
                        <input id="oilPercent" class="p-2.5 border rounded-xl bg-slate-50 input-focus" type="number" value="45" placeholder="Oil %" oninput="calculateMfgCost()">
                        <input id="otherCost" type="number" class="p-2.5 border rounded-xl bg-slate-50 input-focus" placeholder="Misc Cost" oninput="calculateMfgCost()">
                        <input id="saleUnits" type="number" value="1" class="p-2.5 border rounded-xl bg-slate-50 input-focus font-bold text-indigo-600" placeholder="Qty" oninput="calculateMfgCost()">
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] uppercase font-bold text-slate-400">Packaging</label>
                        <div class="grid grid-cols-1 gap-2">
                            <select id="bottleCat" class="text-xs p-2 border rounded-lg bg-slate-50" onchange="calculateMfgCost()">
                                <option value="NA">Bottle Quality (NA)</option><option>ECO</option><option>Moderate</option><option>Premium</option>
                            </select>
                            <input id="bottlePriceInput" type="number" step="0.01" class="text-xs p-2 border rounded-lg bg-slate-50" placeholder="Bottle Price (Manual Override)" oninput="updateTotalFromManual()">
                            
                            <select id="boxNameSelect" class="text-xs p-2 border rounded-lg bg-slate-50" onchange="calculateMfgCost()">
                                <option value="NA">Select Box (NA)</option>
                            </select>
                            <select id="pouchNameSelect" class="text-xs p-2 border rounded-lg bg-slate-50" onchange="calculateMfgCost()">
                                <option value="NA">Select Pouch (NA)</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-indigo-50 p-3 rounded-xl border border-indigo-100">
                        <label class="text-xs font-bold text-indigo-400 uppercase">Est. Mfg Cost (Total for Order)</label>
                        <input id="mfg" type="number" step="0.01" class="w-full bg-transparent text-xl font-bold text-indigo-700 outline-none" value="0.00">
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <input id="sold" class="w-full p-2.5 border border-emerald-200 rounded-xl bg-emerald-50 input-focus font-bold" type="number" placeholder="Selling Price ₹">
                        <input id="saleDiscount" class="w-full p-2.5 border border-orange-200 rounded-xl bg-orange-50 input-focus font-bold" type="number" placeholder="Discount ₹" value="0">
                    </div>
                    
                    <div class="flex gap-4 p-2 bg-slate-50 rounded-xl border">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="saleDelivered" class="w-4 h-4 text-indigo-600">
                            <span class="text-xs font-semibold text-slate-600">Delivered</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="salePaid" class="w-4 h-4 text-emerald-600" checked>
                            <span class="text-xs font-semibold text-slate-600">Paid</span>
                        </label>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <input id="customer" list="customerList" class="p-2.5 border rounded-xl bg-slate-50 input-focus" placeholder="Customer">
                        <input id="reference" list="referenceList" class="p-2.5 border rounded-xl bg-slate-50 input-focus" placeholder="Reference">
                    </div>
                    <input id="date" type="date" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus">
                    <button onclick="addSale()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 rounded-xl transition shadow-lg shadow-emerald-200 mt-2">Complete Sale</button>
                    <p id="saleMsg" class="text-center text-sm font-medium text-emerald-600 mt-1"></p>
                </div>
            </div>

            <div class="lg:col-span-2 glass-card p-6 rounded-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-slate-800">Ungrouped Sales</h2>
                    <div class="flex gap-3 items-center">
                        <button onclick="mergeSelectedSales()" id="mergeInvoicesBtn" class="text-xs bg-indigo-600 text-white px-3 py-1.5 rounded-lg hover:bg-indigo-700 transition hidden shadow-sm shadow-indigo-200">Merge to Invoice</button>
                        <button onclick="printSelectedInvoices()" id="printSelectedBtn" class="text-xs bg-teal-600 text-white px-3 py-1.5 rounded-lg hover:bg-teal-700 transition hidden shadow-sm shadow-teal-200">Print Selected</button>
                        <button onclick="clearFilters('sales')" class="text-xs text-indigo-600 hover:underline">Clear Filters</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm" id="salesRecordsTable">
                        <thead>
                            <tr class="text-slate-500 border-b">
                                <th class="pb-2 w-8"></th>
                                <th class="pb-2 font-semibold sort-header" onclick="setSort('sales', 'productName')">Product ↕</th>
                                <th class="pb-2 font-semibold sort-header" onclick="setSort('sales', 'customerName')">Customer ↕</th>
                                <th class="pb-2 font-semibold text-center">Status</th>
                                <th class="pb-2 font-semibold text-right sort-header" onclick="setSort('sales', 'soldPrice')">Amount ↕</th>
                            </tr>
                            <tr class="bg-slate-50/50">
                                <th class="py-2"></th>
                                <th class="py-2 pr-2"><input type="text" id="filter-sales-product" class="filter-input" placeholder="Filter product..." oninput="renderSalesTable()"></th>
                                <th class="py-2 pr-2"><input type="text" id="filter-sales-customer" class="filter-input" placeholder="Filter customer..." oninput="renderSalesTable()"></th>
                                <th class="py-2 pr-2">
                                    <select id="filter-sales-status" class="filter-input" onchange="renderSalesTable()">
                                        <option value="all">All Status</option>
                                        <option value="undelivered">Undelivered</option>
                                        <option value="unpaid">Unpaid</option>
                                    </select>
                                </th>
                                <th class="py-2"></th>
                            </tr>
                        </thead>
                        <tbody id="salesTable" class="divide-y"></tbody>
                    </table>
                </div>
                <div class="mt-4 pt-4 border-t flex justify-between items-center">
                    <span class="text-slate-500 font-medium">Filtered Sales Total:</span>
                    <span class="text-lg font-bold text-emerald-600">₹ <span id="salesTotal">0</span></span>
                </div>
            </div>
        </div>
    </div>

    <div id="invoices" class="tab-content space-y-6">
        <div class="glass-card p-6 rounded-2xl">
            <h2 class="text-lg font-bold text-slate-800 mb-4">Generated Invoices</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm" id="invoicesRecordsTable">
                    <thead>
                        <tr class="text-slate-500 border-b">
                            <th class="pb-2 font-semibold">Invoice Number</th>
                            <th class="pb-2 font-semibold">Customer</th>
                            <th class="pb-2 font-semibold">Date</th>
                            <th class="pb-2 font-semibold text-center">Status</th>
                            <th class="pb-2 font-semibold text-right">Total Amount</th>
                        </tr>
                    </thead>
                    <tbody id="invoiceTableBody" class="divide-y"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="analytics" class="tab-content space-y-6">
        <div class="glass-card p-6 rounded-2xl">
            <div class="flex flex-wrap gap-4 items-center mb-6">
                <h2 class="text-lg font-bold text-slate-800 mr-auto">Monthly Performance</h2>
                <select id="yearSelect" class="p-2 border rounded-lg text-sm bg-white" onchange="loadAll()">
                    <option value="ALL">All Years</option>
                </select>
                <select id="rangeSelect" class="p-2 border rounded-lg text-sm bg-white" onchange="loadAll()">
                    <option value="ALL">Lifetime</option>
                    <option value="1Y">1 Year</option>
                    <option value="6M">6 Months</option>
                    <option value="3M">3 Months</option>
                    <option value="1M">1 Month</option>
                    <option value="7D">7 Days</option>
                </select>
            </div>
            <div class="overflow-x-auto rounded-xl border mb-8">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 text-slate-600 border-b">
                        <tr>
                            <th class="p-4 font-semibold">Month</th>
                            <th class="p-4 font-semibold">Investment</th>
                            <th class="p-4 font-semibold">Sales</th>
                            <th class="p-4 font-semibold">Profit</th>
                            <th class="p-4 font-semibold">ROI</th>
                        </tr>
                    </thead>
                    <tbody id="monthTable" class="divide-y"></tbody>
                </table>
            </div>
            <div class="grid lg:grid-cols-2 gap-8">
                <div class="p-4 bg-white border rounded-2xl shadow-sm">
                    <h3 class="text-sm font-bold text-slate-500 mb-4 uppercase">Sales vs Investment</h3>
                    <canvas id="salesChartCanvas"></canvas>
                </div>
                <div class="p-4 bg-white border rounded-2xl shadow-sm">
                    <h3 class="text-sm font-bold text-slate-500 mb-4 uppercase">Break-even Curve</h3>
                    <canvas id="breakChartCanvas"></canvas>
                </div>
                <div class="p-4 bg-white border rounded-2xl shadow-sm">
                    <h3 class="text-sm font-bold text-slate-500 mb-4 uppercase">Top 5 Best Sellers (by Profit)</h3>
                    <canvas id="topProductsChartCanvas"></canvas>
                </div>
                <div class="p-4 bg-white border rounded-2xl shadow-sm">
                    <h3 class="text-sm font-bold text-slate-500 mb-4 uppercase">Sales Channel Distribution</h3>
                    <canvas id="channelChartCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>
</main>

<div id="modal" class="modal">
    <div class="bg-white rounded-2xl shadow-2xl w-[95%] max-w-md overflow-y-auto max-h-[90vh] animate-in fade-in zoom-in duration-200">
        <div class="p-6 border-b flex justify-between items-center">
            <h2 id="modalTitle" class="text-xl font-bold text-slate-800">Edit Entry</h2>
            <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600">✕</button>
        </div>
        <div id="modalBody" class="p-6 grid gap-4"></div>
        <div class="p-6 bg-slate-50 flex gap-2">
            <button onclick="saveModal()" class="flex-1 bg-indigo-600 text-white py-2 rounded-xl text-sm font-semibold hover:bg-indigo-700 transition">Update</button>
            <button id="printInvoiceBtn" onclick="printInvoice()" class="flex-1 bg-teal-600 text-white py-2 rounded-xl text-sm font-semibold hover:bg-teal-700 transition hidden">Print</button>
            <button onclick="deleteModal()" class="flex-1 bg-red-100 text-red-600 py-2 rounded-xl text-sm font-semibold hover:bg-red-200 transition">Delete</button>
            <button onclick="closeModal()" class="px-3 py-2 text-slate-500 text-sm font-medium">Cancel</button>
        </div>
    </div>
</div>

<div id="invoiceItemsModal" class="modal">
    <div class="bg-white rounded-2xl shadow-2xl w-[95%] max-w-3xl overflow-y-auto max-h-[90vh] animate-in fade-in zoom-in duration-200">
        <div class="p-6 border-b flex justify-between items-center">
            <div>
                <h2 id="invoiceItemsTitle" class="text-xl font-bold text-slate-800">Invoice Items</h2>
                <p id="invoiceItemsCustomer" class="text-sm text-slate-500"></p>
            </div>
            <button onclick="closeInvoiceModal()" class="text-slate-400 hover:text-slate-600">✕</button>
        </div>
        <div class="p-6 overflow-x-auto">
            <table class="w-full text-left text-sm">
                <thead>
                    <tr class="text-slate-500 border-b">
                        <th class="pb-2">Product</th>
                        <th class="pb-2 text-center">Status</th>
                        <th class="pb-2 text-right">Price</th>
                        <th class="pb-2 text-center">Action</th>
                    </tr>
                </thead>
                <tbody id="invoiceItemsBody" class="divide-y"></tbody>
            </table>
        </div>
        <div class="p-6 bg-slate-50 flex justify-between items-center">
            <button id="printGroupInvoiceBtn" onclick="printGroupInvoice()" class="bg-teal-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-teal-700 transition">Print Full Invoice</button>
            <button onclick="closeInvoiceModal()" class="px-4 py-2 bg-slate-200 rounded-lg text-slate-700 font-medium">Close</button>
        </div>
    </div>
</div>

<datalist id="oilList"></datalist>
<datalist id="nameList"></datalist>
<datalist id="designerList"></datalist>
<datalist id="supplierList"></datalist>
<datalist id="customerList"></datalist>
<datalist id="referenceList"></datalist>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // --- Global State ---
    let stockCache = [];
    let salesCache = [];
    let editType = "", editId = "";
    let currentInvoiceGroup = null;
    let salesChart = null, breakChart = null;
    let topProductsChart = null, channelChart = null;

    let stockSort = { key: 'id', dir: -1 };
    let salesSort = { key: 'id', dir: -1 };

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.getElementById('tab-' + tabId).classList.add('active');
    }

    async function checkAuth(){
        const r = await fetch("/api/check-auth");
        const d = await r.json();
        if(!d.authenticated) window.location.href="/login.html";
    }
    checkAuth();

    document.getElementById('date').value = new Date().toISOString().split("T")[0];

    function filterSalesStatus(status) {
        showTab('sales-entry');
        document.getElementById('filter-sales-status').value = status;
        renderSalesTable();
    }

    function changeFields(){
        const c = category.value;
        dynamicFields.innerHTML = getFieldsHTML(c);
        if(document.getElementById('stockPurchaseDate')) {
            document.getElementById('stockPurchaseDate').value = new Date().toISOString().split("T")[0];
        }
        updateNameList(c);
    }

    function getFieldsHTML(c, data = {}) {
        let html = "";
        if (c !== "Bottle") {
            html += `<input id="${data._id ? 'e_' : ''}name" list="nameList" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus" placeholder="Item Name" value="${data.name || ''}">`;
        }
        if(c === "Attar Oil"){
            html += `
            <input id="${data._id ? 'e_' : ''}designerName" list="designerList" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus" placeholder="Designer Name" value="${data.designerName || ''}">
            <input id="${data._id ? 'e_' : ''}supplier" list="supplierList" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus" placeholder="Supplier" value="${data.supplier || ''}">
            <select id="${data._id ? 'e_' : ''}size" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus">
                <option value="25" ${data.size_ml==25?'selected':''}>25 ml</option><option value="50" ${data.size_ml==50?'selected':''}>50 ml</option>
                <option value="100" ${data.size_ml==100?'selected':''}>100 ml</option><option value="250" ${data.size_ml==250?'selected':''}>250 ml</option>
                <option value="500" ${data.size_ml==500?'selected':''}>500 ml</option><option value="1000" ${data.size_ml==1000?'selected':''}>1000 ml</option>
            </select>`;
        }
        if(c === "Raw Perfume") {
             html += `<input id="${data._id ? 'e_' : ''}size" type="number" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus" placeholder="Quantity in ml" value="${data.size_ml || ''}">`;
        } else if(c === "Aroma Chemical"){
             html += `<input id="${data._id ? 'e_' : ''}size" type="number" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus" placeholder="Quantity in grams" value="${data.size_ml || ''}">`;
        }
        if(c === "Bottle"){
            html += `
            <select id="${data._id ? 'e_' : ''}size" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus">
                <option value="8" ${data.size_ml==8?'selected':''}>8 ml Bottle</option>
                <option value="20" ${data.size_ml==20?'selected':''}>20 ml Bottle</option>
                <option value="30" ${data.size_ml==30?'selected':''}>30 ml Bottle</option>
                <option value="50" ${data.size_ml==50?'selected':''}>50 ml Bottle</option>
                <option value="100" ${data.size_ml==100?'selected':''}>100 ml Bottle</option>
            </select>
            <select id="${data._id ? 'e_' : ''}subCategory" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus">
                <option value="" ${!data.subCategory?'selected':''}>Quality: NA</option>
                <option ${data.subCategory=='ECO'?'selected':''}>ECO</option>
                <option ${data.subCategory=='Moderate'?'selected':''}>Moderate</option>
                <option ${data.subCategory=='Premium'?'selected':''}>Premium</option>
            </select>
            <select id="${data._id ? 'e_' : ''}type" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus">
                <option ${data.type=='Perfume'?'selected':''}>Perfume</option>
                <option ${data.type=='Attar'?'selected':''}>Attar</option>
            </select>`;
        }
        html += `
        <div class="grid grid-cols-2 gap-2">
            <input id="${data._id ? 'e_' : ''}units" type="number" class="p-2.5 border rounded-xl bg-slate-50 input-focus" placeholder="Units" value="${data.units || ''}">
            <input id="${data._id ? 'e_' : ''}cost" type="number" class="p-2.5 border rounded-xl bg-slate-50 input-focus" placeholder="Total Cost" value="${data.cost || ''}">
        </div>
        <div class="space-y-1">
            <label class="text-[10px] uppercase font-bold text-slate-400">Purchase Date</label>
            <input id="${data._id ? 'e_' : ''}stockPurchaseDate" type="date" class="w-full p-2.5 border rounded-xl bg-slate-50 input-focus" value="${data.purchaseDate ? data.purchaseDate.split('T')[0] : ''}">
        </div>`;
        return html;
    }

    function updateNameList(selectedCategory) {
        const filteredNames = [...new Set(stockCache.filter(s => s.category === selectedCategory).map(s => s.name))].filter(Boolean);
        nameList.innerHTML = filteredNames.map(v => `<option value="${v}">`).join("");
    }

    function setSort(table, key) {
        if(table === 'stock') {
            stockSort.dir = (stockSort.key === key) ? stockSort.dir * -1 : 1;
            stockSort.key = key;
            renderStockTable();
        } else {
            salesSort.dir = (salesSort.key === key) ? salesSort.dir * -1 : 1;
            salesSort.key = key;
            renderSalesTable();
        }
    }

    function clearFilters(table) {
        if(table === 'stock') {
            document.getElementById('filter-stock-name').value = '';
            document.getElementById('filter-stock-category').value = '';
            renderStockTable();
        } else {
            document.getElementById('filter-sales-product').value = '';
            document.getElementById('filter-sales-customer').value = '';
            document.getElementById('filter-sales-status').value = 'all';
            renderSalesTable();
        }
    }

    function renderStockTable() {
        const nameFilter = document.getElementById('filter-stock-name').value.toLowerCase();
        const catFilter = document.getElementById('filter-stock-category').value;
        let filtered = stockCache.filter(s => (s.name || "").toLowerCase().includes(nameFilter) && (catFilter === "" || s.category === catFilter));
        filtered.sort((a,b) => {
            let valA = a[stockSort.key], valB = b[stockSort.key];
            if(typeof valA === 'string') return valA.localeCompare(valB) * stockSort.dir;
            return (valA - valB) * stockSort.dir;
        });
        stockTable.innerHTML = filtered.map(s => `
            <tr onclick='openModal("stock",${JSON.stringify(s).replace(/"/g,"&quot;")})'>
                <td class="py-3 font-medium">${s.name||""}</td>
                <td class="py-3 text-slate-500">${s.category||""}</td>
                <td class="py-3 text-right font-mono">${s.size_ml > 0 ? s.size_ml + (s.category === 'Aroma Chemical' ? 'g' : 'ml') : s.units + ' U'}</td>
                <td class="py-3 text-right font-bold">₹${s.cost||0}</td>
            </tr>`).join("");
        stockTotal.innerText = filtered.reduce((a,b)=>a+(b.cost||0),0).toFixed(2);
    }

    function renderSalesTable() {
        const prodFilter = document.getElementById('filter-sales-product').value.toLowerCase();
        const custFilter = document.getElementById('filter-sales-customer').value.toLowerCase();
        const statusFilter = document.getElementById('filter-sales-status').value;

        // ONLY Show UNGROUPED Sales here
        let filtered = salesCache.filter(s => {
            if(s.invoiceNumber) return false; // Filter out grouped items

            const matchesSearch = (s.productName || "").toLowerCase().includes(prodFilter) && (s.customerName || "").toLowerCase().includes(custFilter);
            let matchesStatus = true;
            if(statusFilter === 'undelivered') matchesStatus = s.isDelivered === false;
            if(statusFilter === 'unpaid') matchesStatus = s.isPaid === false;
            return matchesSearch && matchesStatus;
        });

        filtered.sort((a,b) => {
            let valA = a[salesSort.key], valB = b[salesSort.key];
            if(typeof valA === 'string') return valA.localeCompare(valB) * salesSort.dir;
            return (valA - valB) * salesSort.dir;
        });

        salesTable.innerHTML = filtered.map(item => `
            <tr class="sales-row" onclick='openModal("sales",${JSON.stringify(item).replace(/"/g,"&quot;")})'>
                <td class="py-3 pl-2" onclick="event.stopPropagation()">
                    <input type="checkbox" class="sale-checkbox w-4 h-4 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500 cursor-pointer" value="${item._id}" onchange="togglePrintButton()">
                </td>
                <td class="py-3 font-medium">${item.productName||""}</td>
                <td class="py-3 text-slate-500">${item.customerName||""}</td>
                <td class="py-3 text-center">
                    <div class="flex items-center justify-center gap-1">
                        <span class="w-2 h-2 rounded-full ${item.isDelivered ? 'bg-emerald-500' : 'bg-orange-500'}"></span>
                        <span class="w-2 h-2 rounded-full ${item.isPaid ? 'bg-emerald-500' : 'bg-red-500'}"></span>
                    </div>
                </td>
                <td class="py-3 text-right font-bold text-slate-800">₹${item.soldPrice?.toFixed(2)||0}</td>
            </tr>
        `).join("");

        salesTotal.innerText = filtered.reduce((a,b)=>a+(b.soldPrice||0),0).toFixed(2);
        togglePrintButton(); 
        
        renderInvoicesTable(); // Render the invoices tab as well
    }

    function renderInvoicesTable() {
        let invoiceMap = {};

        salesCache.forEach(s => {
            if (s.invoiceNumber) {
                if(!invoiceMap[s.invoiceNumber]) {
                    invoiceMap[s.invoiceNumber] = {
                        invoiceNumber: s.invoiceNumber,
                        customerName: s.customerName,
                        soldPrice: 0,
                        items: [],
                        isPaid: true,
                        isDelivered: true,
                        saleDate: s.saleDate
                    };
                }
                invoiceMap[s.invoiceNumber].items.push(s);
                invoiceMap[s.invoiceNumber].soldPrice += (s.soldPrice || 0);
                if (!s.isPaid) invoiceMap[s.invoiceNumber].isPaid = false;
                if (!s.isDelivered) invoiceMap[s.invoiceNumber].isDelivered = false;
            }
        });

        const displayList = Object.values(invoiceMap).sort((a,b) => new Date(b.saleDate) - new Date(a.saleDate));

        document.getElementById('invoiceTableBody').innerHTML = displayList.map(item => `
            <tr onclick='openInvoiceModal("${item.invoiceNumber}")'>
                <td class="py-3 font-bold text-indigo-600">${item.invoiceNumber}</td>
                <td class="py-3 text-slate-600">${item.customerName||"Cash Customer"}</td>
                <td class="py-3 text-slate-500 text-sm">${new Date(item.saleDate).toLocaleDateString()}</td>
                <td class="py-3 text-center">
                    <div class="flex items-center justify-center gap-1">
                        <span class="w-2 h-2 rounded-full ${item.isDelivered ? 'bg-emerald-500' : 'bg-orange-500'}"></span>
                        <span class="w-2 h-2 rounded-full ${item.isPaid ? 'bg-emerald-500' : 'bg-red-500'}"></span>
                    </div>
                </td>
                <td class="py-3 text-right font-bold text-slate-800">₹${item.soldPrice?.toFixed(2)||0}</td>
            </tr>
        `).join("");
    }

    function togglePrintButton() {
        const checkedBoxes = document.querySelectorAll('.sale-checkbox:checked');
        const printBtn = document.getElementById('printSelectedBtn');
        const mergeBtn = document.getElementById('mergeInvoicesBtn');
        if(checkedBoxes.length > 0) {
            printBtn.classList.remove('hidden');
            mergeBtn.classList.remove('hidden');
        } else {
            printBtn.classList.add('hidden');
            mergeBtn.classList.add('hidden');
        }
    }

    // --- Invoice Modal Handlers ---
    function openInvoiceModal(invoiceNumber) {
        currentInvoiceGroup = invoiceNumber;
        const items = salesCache.filter(s => s.invoiceNumber === invoiceNumber);
        const customer = items.length > 0 ? items[0].customerName : "";

        document.getElementById('invoiceItemsTitle').innerText = `Invoice: ${invoiceNumber}`;
        document.getElementById('invoiceItemsCustomer').innerText = `Customer: ${customer || 'N/A'}`;
        
        document.getElementById('invoiceItemsBody').innerHTML = items.map(s => `
            <tr>
                <td class="py-3 font-medium">${s.productName||""}</td>
                <td class="py-3 text-center">
                    <div class="flex items-center justify-center gap-1">
                        <span class="w-2 h-2 rounded-full ${s.isDelivered ? 'bg-emerald-500' : 'bg-orange-500'}"></span>
                        <span class="w-2 h-2 rounded-full ${s.isPaid ? 'bg-emerald-500' : 'bg-red-500'}"></span>
                    </div>
                </td>
                <td class="py-3 text-right font-bold text-slate-800">₹${s.soldPrice?.toFixed(2)||0}</td>
                <td class="py-3 text-center">
                    <button onclick='editInvoiceItem(${JSON.stringify(s).replace(/"/g,"&quot;")})' class="text-xs font-semibold bg-indigo-100 text-indigo-600 px-3 py-1.5 rounded-lg hover:bg-indigo-200 transition">Edit Details</button>
                </td>
            </tr>
        `).join("");
        document.getElementById('invoiceItemsModal').style.display = "flex";
    }

    function closeInvoiceModal() { 
        document.getElementById('invoiceItemsModal').style.display = "none"; 
        currentInvoiceGroup = null;
    }
    
    function editInvoiceItem(item) {
        closeInvoiceModal();
        openModal("sales", item);
    }

    // --- Merge API Request ---
    async function mergeSelectedSales() {
        const checkedBoxes = document.querySelectorAll('.sale-checkbox:checked');
        if(checkedBoxes.length === 0) return;

        let saleIdsToMerge = Array.from(checkedBoxes).map(cb => cb.value);

        if (!confirm("Group these selected items into a single Invoice?")) return;

        const res = await fetch("/api/sales/merge", {
            method: "POST", headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ ids: saleIdsToMerge })
        });
        const data = await res.json();
        
        if(data.success) {
            alert(`Successfully merged! Created Invoice: ${data.invoiceNumber}`);
            document.querySelectorAll('.sale-checkbox').forEach(cb => cb.checked = false);
            togglePrintButton();
            loadAll();
            showTab('invoices'); // Switch to invoices tab automatically
        }
    }

    // --- Standard Modal Functions ---
    function openModal(type, data){
        editType = type; editId = data._id;
        modal.style.display = "flex";
        modalTitle.innerText = type === "stock" ? `Edit Stock: ${data.category}` : "Edit Sale Record";
        
        const printBtn = document.getElementById("printInvoiceBtn");

        if(type === "stock") {
            printBtn.classList.add("hidden");
            updateNameList(data.category);
            modalBody.innerHTML = getFieldsHTML(data.category, data);
        } else {
            printBtn.classList.remove("hidden");
            modalBody.innerHTML = `
                ${data.invoiceNumber ? `<div class="p-2 bg-indigo-50 border border-indigo-100 rounded-lg text-xs font-bold text-indigo-600 mb-2">Part of Invoice: ${data.invoiceNumber}</div>` : ''}
                <div class="grid grid-cols-3 gap-2">
                    <input id="e_mfg" placeholder="Total Mfg Cost" class="p-2.5 border rounded-xl bg-slate-50" type="number" value="${data.manufacturingCost||0}">
                    <input id="e_sold" placeholder="Total Sold Price" class="p-2.5 border rounded-xl bg-slate-50" type="number" value="${data.soldPrice||0}">
                    <input id="e_discount" placeholder="Discount ₹" class="p-2.5 border rounded-xl bg-slate-50" type="number" value="${data.discount||0}">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input id="e_productName" placeholder="Product" class="p-2.5 border rounded-xl bg-slate-50" value="${data.productName||""}">
                    <input id="e_units" placeholder="Units Sold" class="p-2.5 border rounded-xl bg-slate-50 font-bold" type="number" value="${data.units||1}">
                </div>
                <input id="e_customerName" list="customerList" placeholder="Customer" class="p-2.5 border rounded-xl bg-slate-50" value="${data.customerName||""}">
                <input id="e_referenceSource" list="referenceList" placeholder="Reference" class="p-2.5 border rounded-xl bg-slate-50" value="${data.referenceSource||""}">
                <input id="e_saleDate" type="date" class="p-2.5 border rounded-xl bg-slate-50" value="${data.saleDate ? data.saleDate.split('T')[0] : ''}">
                <div class="flex gap-4 p-3 bg-slate-50 rounded-xl border">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="e_isDelivered" class="w-5 h-5" ${data.isDelivered ? 'checked' : ''}>
                        <span class="font-bold text-slate-700">Delivered</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="e_isPaid" class="w-5 h-5" ${data.isPaid ? 'checked' : ''}>
                        <span class="font-bold text-slate-700">Paid</span>
                    </label>
                </div>
            `;
        }
    }

    async function saveModal(){
        let body = {};
        if(editType === "stock") {
            const cat = stockCache.find(x => x._id === editId).category;
            body = {
                name: (cat === "Bottle") ? `${document.getElementById("e_size").value}ml Bottle` : (document.getElementById("e_name")?.value || ""),
                designerName: document.getElementById("e_designerName")?.value || "",
                supplier: document.getElementById("e_supplier")?.value || "",
                subCategory: document.getElementById("e_subCategory")?.value || "",
                type: document.getElementById("e_type")?.value || "",
                size_ml: Number(document.getElementById("e_size")?.value || 0),
                units: Number(document.getElementById("e_units")?.value || 0),
                cost: Number(document.getElementById("e_cost")?.value || 0),
                purchaseDate: document.getElementById("e_stockPurchaseDate")?.value
            };
        } else {
            body = {
                productName: document.getElementById("e_productName").value,
                customerName: document.getElementById("e_customerName").value,
                referenceSource: document.getElementById("e_referenceSource").value,
                manufacturingCost: Number(document.getElementById("e_mfg").value),
                soldPrice: Number(document.getElementById("e_sold").value),
                discount: Number(document.getElementById("e_discount").value || 0),
                saleDate: document.getElementById("e_saleDate").value,
                units: Number(document.getElementById("e_units").value),
                isDelivered: document.getElementById("e_isDelivered").checked,
                isPaid: document.getElementById("e_isPaid").checked
            };
        }
        await fetch(`/api/${editType}/${editId}`, {
            method: "PUT", headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)
        });
        closeModal(); loadAll();
    }

    function closeModal(){ modal.style.display="none"; }
    
    async function deleteModal(){
        if(confirm("Are you sure?")) {
            await fetch(`/api/${editType}/${editId}`, {method: "DELETE"});
            closeModal(); loadAll();
        }
    }

    async function loadDropdowns(){
        try {
            const stock = await (await fetch("/api/stock")).json();
            stockCache = stock;
            designerList.innerHTML = [...new Set(stock.map(s=>s.designerName))].filter(Boolean).map(v=>`<option value="${v}">`).join("");
            supplierList.innerHTML = [...new Set(stock.map(s=>s.supplier))].filter(Boolean).map(v=>`<option value="${v}">`).join("");
            oilList.innerHTML = [...new Set(stock.filter(s=>s.category==="Attar Oil").map(o=>o.name))].map(v=>`<option value="${v}">`).join("");
            boxNameSelect.innerHTML = `<option value="NA">Select Box (NA)</option>` + [...new Set(stock.filter(s=>s.category==="Box").map(s=>s.name))].map(n=>`<option value="${n}">${n}</option>`).join("");
            pouchNameSelect.innerHTML = `<option value="NA">Select Pouch (NA)</option>` + [...new Set(stock.filter(s=>s.category==="Pouch").map(s=>s.name))].map(n=>`<option value="${n}">${n}</option>`).join("");
            changeFields();
        } catch(e) { console.error(e); }
    }

    function calculateMfgCost(){
        const oil = stockCache.find(s => s.name === productName.value && s.category === "Attar Oil");
        const qtySize = Number(saleSize.value || 0);
        const orderQty = Number(saleUnits.value || 1);
        const oilPercentVal = Number(oilPercent.value || 0);
        const extraCost = Number(otherCost.value || 0);
        const bottleQuality = bottleCat.value;
        
        let unitCost = 0;

        if(oil) {
            if(saleCat.value === "Attar"){
                unitCost += (oil.pricePerUnit || 0) * qtySize;
            } else {
                const oilQty = qtySize * (oilPercentVal / 100);
                const ethanolQty = qtySize - oilQty;
                const ethStock = stockCache.find(s => s.name?.toLowerCase().includes("ethanol"));
                unitCost += (oilQty * (oil.pricePerUnit || 0)) + (ethanolQty * (ethStock ? ethStock.pricePerUnit : 0));
            }
        }

        if(bottleQuality !== "NA"){
            const b = stockCache.find(s => s.category === "Bottle" && s.subCategory === bottleQuality && s.size_ml === qtySize);
            if(b) {
                bottlePriceInput.value = b.pricePerUnit.toFixed(2);
                bottlePriceInput.style.borderColor = "";
                bottlePriceInput.style.backgroundColor = "";
            } else {
                bottlePriceInput.style.borderColor = "#f43f5e";
                bottlePriceInput.style.backgroundColor = "#fff1f2";
            }
        } else {
            bottlePriceInput.value = 0;
            bottlePriceInput.style.borderColor = "";
        }

        if(boxNameSelect.value !== "NA"){
            const box = stockCache.find(s => s.category === "Box" && s.name === boxNameSelect.value);
            if(box) unitCost += box.pricePerUnit || 0;
        }
        if(pouchNameSelect.value !== "NA"){
            const pouch = stockCache.find(s => s.category === "Pouch" && s.name === pouchNameSelect.value);
            if(pouch) unitCost += pouch.pricePerUnit || 0;
        }

        updateTotalFromManual();
    }

    function updateTotalFromManual() {
        const oil = stockCache.find(s => s.name === productName.value && s.category === "Attar Oil");
        const qtySize = Number(saleSize.value || 0);
        const orderQty = Number(saleUnits.value || 1);
        const oilPercentVal = Number(oilPercent.value || 0);
        const extraCost = Number(otherCost.value || 0);
        const manualBottle = Number(bottlePriceInput.value || 0);

        let perUnit = 0;
        if(oil) {
             if(saleCat.value === "Attar"){
                perUnit += (oil.pricePerUnit || 0) * qtySize;
            } else {
                const oilQty = qtySize * (oilPercentVal / 100);
                const ethanolQty = qtySize - oilQty;
                const ethStock = stockCache.find(s => s.name?.toLowerCase().includes("ethanol"));
                perUnit += (oilQty * (oil.pricePerUnit || 0)) + (ethanolQty * (ethStock ? ethStock.pricePerUnit : 0));
            }
        }

        perUnit += manualBottle;

        if(boxNameSelect.value !== "NA"){
            const box = stockCache.find(s => s.category === "Box" && s.name === boxNameSelect.value);
            if(box) perUnit += box.pricePerUnit || 0;
        }
        if(pouchNameSelect.value !== "NA"){
            const pouch = stockCache.find(s => s.category === "Pouch" && s.name === pouchNameSelect.value);
            if(pouch) perUnit += pouch.pricePerUnit || 0;
        }

        const grandTotal = (perUnit * orderQty) + extraCost;
        mfg.value = grandTotal.toFixed(2);
    }

    function changeSaleMode(){
        const type = saleCat.value;
        saleSize.innerHTML = "";
        if(type === "Attar"){
            [3,6,8,12,15].forEach(v=>{ saleSize.innerHTML += `<option value="${v}">${v} ml</option>`; });
            oilPercent.parentElement.style.display = "none";
        } else {
            [8,20,30,50,100].forEach(v=>{ saleSize.innerHTML += `<option value="${v}">${v} ml</option>`; });
            oilPercent.parentElement.style.display = "grid";
        }
        calculateMfgCost();
    }

    async function addStock(){
        const cat = category.value;
        const body = {
            category: cat,
            name: (cat === "Bottle") ? `${document.getElementById("size").value}ml Bottle` : (document.getElementById("name")?.value || ""),
            designerName: document.getElementById("designerName")?.value || "",
            supplier: document.getElementById("supplier")?.value || "",
            subCategory: document.getElementById("subCategory")?.value || "",
            type: document.getElementById("type")?.value || "",
            size_ml: Number(document.getElementById("size")?.value || 0),
            units: Number(document.getElementById("units")?.value || 0),
            cost: Number(document.getElementById("cost")?.value || 0),
            purchaseDate: document.getElementById("stockPurchaseDate")?.value
        };
        await fetch("/api/stock",{method:"POST", headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        
        const msg = document.getElementById("stockMsg");
        msg.innerText = "Stock added successfully!";
        setTimeout(() => msg.innerText = "", 3000);

        loadAll(); loadDropdowns();
    }

    async function addSale(){
        await fetch("/api/sales",{method:"POST", headers:{'Content-Type':'application/json'}, body:JSON.stringify({
            productName:productName.value, customerName:customer.value, referenceSource:reference.value,
            manufacturingCost:Number(mfg.value), soldPrice:Number(sold.value), discount:Number(saleDiscount.value || 0), 
            saleDate:date.value, size_ml:Number(saleSize.value),
            units: Number(saleUnits.value),
            isDelivered: saleDelivered.checked, isPaid: salePaid.checked
        })});

        const msg = document.getElementById("saleMsg");
        msg.innerText = "Sale completed successfully!";
        setTimeout(() => msg.innerText = "", 3000);

        loadAll();
    }

    async function loadAll(){
        const stock = await (await fetch("/api/stock")).json();
        const salesData = await (await fetch("/api/sales")).json();
        const dash = await (await fetch("/api/dashboard")).json();

        investment.innerText = "₹" + dash.totalInvestment.toLocaleString();
        document.getElementById("sales").innerText = "₹" + dash.totalSales.toLocaleString();
        profit.innerText = "₹" + dash.totalProfit.toLocaleString();
        roi.innerText = dash.roi.toFixed(2);

        const netPLValue = dash.totalSales - dash.totalInvestment;
        const netPLElem = document.getElementById("net-pl");
        const netPLCard = document.getElementById("net-pl-card");
        netPLElem.innerText = (netPLValue >= 0 ? "+ ₹" : "- ₹") + Math.abs(netPLValue).toLocaleString();
        if (netPLValue >= 0) {
            netPLElem.className = "text-lg font-bold text-emerald-600 mt-1";
            netPLCard.style.borderColor = "#10b981";
        } else {
            netPLElem.className = "text-lg font-bold text-rose-600 mt-1";
            netPLCard.style.borderColor = "#f43f5e";
        }

        const breakevenPercent = dash.totalInvestment > 0 ? (dash.totalSales / dash.totalInvestment * 100).toFixed(1) : 0;
        document.getElementById("breakeven").innerText = breakevenPercent + "%";

        const undeliveredCount = salesData.filter(s => s.isDelivered === false).length;
        const unpaidCount = salesData.filter(s => s.isPaid === false).length;
        document.getElementById('count-undelivered').innerText = undeliveredCount;
        document.getElementById('count-unpaid').innerText = unpaidCount;

        stockCache = stock;
        salesCache = salesData;

        document.getElementById('customerList').innerHTML = [...new Set(salesData.map(s=>s.customerName))].filter(Boolean).map(v=>`<option value="${v}">`).join("");
        document.getElementById('referenceList').innerHTML = [...new Set(salesData.map(s=>s.referenceSource))].filter(Boolean).map(v=>`<option value="${v}">`).join("");

        renderStockTable();
        renderSalesTable();
        buildAnalytics(stock, salesData);

        const years = [...new Set(salesData.map(s => new Date(s.saleDate).getFullYear()))];
        yearSelect.innerHTML = `<option value="ALL">All Years</option>` + years.map(y => `<option value="${y}">${y}</option>`).join("");
    }

    function buildAnalytics(stock, salesData) {
        const months = {};
        const productStats = {};
        const channelStats = {};
        const now = new Date();
        const selectedYear = yearSelect.value;
        const selectedRange = rangeSelect.value;

        function inRange(date) {
            if (selectedYear !== "ALL" && date.getFullYear().toString() !== selectedYear) return false;
            if (selectedRange === "ALL") return true;
            const diff = now - date;
            const day = 1000 * 60 * 60 * 24;
            if (selectedRange === "7D") return diff <= 7 * day;
            if (selectedRange === "1M") return diff <= 30 * day;
            if (selectedRange === "3M") return diff <= 90 * day;
            if (selectedRange === "6M") return diff <= 180 * day;
            if (selectedRange === "1Y") return diff <= 365 * day;
            return true;
        }

        stock.forEach(s => {
            const d = new Date(s.purchaseDate || s._id.substring(0, 8) * 1000);
            if (!inRange(d)) return;
            const key = d.toLocaleString("default", { month: "short", year: "numeric" });
            if (!months[key]) months[key] = { investment: 0, sales: 0, profit: 0 };
            months[key].investment += Number(s.cost || 0);
        });

        salesData.forEach(s => {
            const d = new Date(s.saleDate || Date.now());
            if (!inRange(d)) return;
            const key = d.toLocaleString("default", { month: "short", year: "numeric" });
            if (!months[key]) months[key] = { investment: 0, sales: 0, profit: 0 };
            months[key].sales += Number(s.soldPrice || 0);
            months[key].profit += Number(s.profit || 0);
            const pName = s.productName || "Unknown";
            productStats[pName] = (productStats[pName] || 0) + Number(s.profit || 0);
            const channel = s.referenceSource || "Other";
            channelStats[channel] = (channelStats[channel] || 0) + Number(s.soldPrice || 0);
        });

        const labels = Object.keys(months).sort((a, b) => new Date(a) - new Date(b));
        monthTable.innerHTML = labels.map(m => {
            const x = months[m];
            const roi = x.investment ? (x.profit / x.investment).toFixed(2) : "0.00";
            return `<tr><td class="p-4">${m}</td><td class="p-4 font-medium">₹${x.investment.toFixed(2)}</td><td class="p-4 font-medium">₹${x.sales.toFixed(2)}</td><td class="p-4 font-bold text-emerald-600">₹${x.profit.toFixed(2)}</td><td class="p-4 font-bold">${roi}</td></tr>`;
        }).join("");

        if (salesChart) salesChart.destroy();
        salesChart = new Chart(salesChartCanvas, {
            type: "bar",
            data: { labels, datasets: [{ label: "Investment", data: labels.map(m => months[m].investment), backgroundColor: '#818cf8' }, { label: "Sales", data: labels.map(m => months[m].sales), backgroundColor: '#10b981' }] },
            options: { responsive: true, plugins: { legend: { position: "top" } } }
        });

        let cumInv = 0, cumSales = 0;
        const invArr = [], salesArr = [];
        labels.forEach(m => { cumInv += months[m].investment; cumSales += months[m].sales; invArr.push(cumInv); salesArr.push(cumSales); });
        if (breakChart) breakChart.destroy();
        breakChart = new Chart(breakChartCanvas, {
            type: "line",
            data: { labels, datasets: [{ label: "Cum. Investment", data: invArr, borderColor: '#f59e0b', tension: 0.3 }, { label: "Cum. Sales", data: salesArr, borderColor: '#6366f1', tension: 0.3 }] },
            options: { responsive: true }
        });

        const top5Products = Object.entries(productStats).sort(([, a], [, b]) => b - a).slice(0, 5);
        if (topProductsChart) topProductsChart.destroy();
        topProductsChart = new Chart(topProductsChartCanvas, {
            type: "bar",
            data: { labels: top5Products.map(p => p[0]), datasets: [{ label: "Net Profit", data: top5Products.map(p => p[1]), backgroundColor: '#ec4899' }] },
            options: { indexAxis: 'y', responsive: true }
        });

        if (channelChart) channelChart.destroy();
        channelChart = new Chart(channelChartCanvas, {
            type: "doughnut",
            data: { labels: Object.keys(channelStats), datasets: [{ data: Object.values(channelStats), backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#06b6d4', '#8b5cf6'] }] },
            options: { responsive: true, plugins: { legend: { position: "bottom" } } }
        });
    }

    // --- PDF INVOICE GENERATOR (SINGLE, MULTIPLE & GROUP) ---
    function printInvoice() {
        const doc = new window.jspdf.jsPDF();
        const sale = salesCache.find(s => s._id === editId);
        if(!sale) return;

        const img = new Image();
        img.src = '/logo.png';
        img.onload = function() {
            doc.addImage(img, 'PNG', 14, 10, 30, 30);
            generatePDFText(doc, [sale]);
        };
        img.onerror = function() {
            generatePDFText(doc, [sale]);
        };
    }

    function printGroupInvoice() {
        if(!currentInvoiceGroup) return;
        const items = salesCache.filter(s => s.invoiceNumber === currentInvoiceGroup);
        if(items.length === 0) return;

        const doc = new window.jspdf.jsPDF();
        const img = new Image();
        img.src = '/logo.png';
        img.onload = function() {
            doc.addImage(img, 'PNG', 14, 10, 30, 30);
            generatePDFText(doc, items, true, currentInvoiceGroup);
        };
        img.onerror = function() {
            generatePDFText(doc, items, true, currentInvoiceGroup);
        };
    }

    function printSelectedInvoices() {
        const checkedBoxes = document.querySelectorAll('.sale-checkbox:checked');
        if(checkedBoxes.length === 0) return;

        let selectedSales = [];

        checkedBoxes.forEach(cb => {
            const sale = salesCache.find(s => s._id === cb.value);
            if (sale) selectedSales.push(sale);
        });

        const doc = new window.jspdf.jsPDF();
        const img = new Image();
        img.src = '/logo.png';
        img.onload = function() {
            doc.addImage(img, 'PNG', 14, 10, 30, 30);
            generatePDFText(doc, selectedSales, true, "Bulk");
        };
        img.onerror = function() {
            generatePDFText(doc, selectedSales, true, "Bulk");
        };
    }

    function generatePDFText(doc, sales, isBulk = false, groupInvNum = null) {
        doc.setFontSize(22);
        doc.setTextColor(79, 70, 229); 
        doc.text("Eternal Essence", 50, 20);
        
        doc.setFontSize(10);
        doc.setTextColor(100);
        doc.text("Mumbai 400011", 50, 28);
        
        doc.setFontSize(16);
        doc.setTextColor(40);

        const firstSale = sales[0];
        const displayInvNum = isBulk ? (groupInvNum || 'Bulk') : (firstSale.invoiceNumber || 'Singular');

        doc.text(`INVOICE: ${displayInvNum}`, 14, 50);

        doc.setFontSize(10);
        doc.text(`Date: ${new Date(firstSale.saleDate).toLocaleDateString()}`, 14, 58);
        doc.text(`Customer: ${firstSale.customerName || 'Cash Customer'}`, 14, 64);
        if (!isBulk && firstSale.referenceSource) doc.text(`Reference: ${firstSale.referenceSource}`, 14, 70);

        let totalDiscount = 0;
        let grandTotal = 0;

        const tableBody = sales.map(sale => {
            const discount = sale.discount || 0;
            const itemTotal = sale.soldPrice || 0;
            const subTotal = itemTotal + discount;
            
            totalDiscount += discount;
            grandTotal += itemTotal;

            return [
                sale.productName || 'Perfume / Attar',
                sale.units || 1,
                `Rs ${subTotal.toFixed(2)}`,
                `Rs ${subTotal.toFixed(2)}`
            ];
        });

        doc.autoTable({
            startY: 80,
            head: [['Item Description', 'Qty', 'Price', 'Total']],
            body: tableBody,
            theme: 'grid',
            headStyles: { fillColor: [79, 70, 229] }
        });

        const finalY = doc.lastAutoTable.finalY || 80;
        
        if (totalDiscount > 0) {
            doc.text(`Total Discount: Rs ${totalDiscount.toFixed(2)}`, 140, finalY + 10);
        }
        
        doc.setFontSize(12);
        doc.setFont("helvetica", "bold");
        doc.text(`Grand Total: Rs ${grandTotal.toFixed(2)}`, 140, finalY + (totalDiscount > 0 ? 18 : 10));

        const fileName = isBulk ? `Invoice_${displayInvNum}.pdf` : `Invoice_${firstSale.customerName || 'Customer'}_${firstSale._id}.pdf`;
        doc.save(fileName);

        if(isBulk && groupInvNum === "Bulk") {
            document.querySelectorAll('.sale-checkbox').forEach(cb => cb.checked = false);
            togglePrintButton();
        }
    }

    async function logout(){ await fetch("/api/logout",{method:"POST"}); window.location.href="/login.html"; }

    loadDropdowns(); loadAll(); changeSaleMode();
</script>
</body>
</html>